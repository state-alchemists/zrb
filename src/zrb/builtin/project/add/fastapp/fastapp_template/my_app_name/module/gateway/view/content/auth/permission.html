<main class="container">
    <article>
        <h1>Permission</h1>

        <form id="itemForm">
            <input type="hidden" id="itemId">
            <label>
                Name:
                <input type="text" id="itemName" required>
            </label>
            <label>
                Description:
                <input type="text" id="itemDescription" required>
            </label>
            <button type="submit">Save</button>
        </form>

        <table id="permission-table" class="striped">
            <thead>
                <tr>
                    <th scope="col">ID</th>
                    <th scope="col">Name</th>
                    <th scope="col">Description</th>
                    <th scope="col">Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <nav id="pagination"></nav>
    </article>
</main>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const apiUrl = "/api/v1/permissions";
        let currentPage = 1;
        const pageSize = 5;

        async function fetchItems(page = 1) {
            try {
                const res = await fetch(`${apiUrl}?page=${page}&page_size=${pageSize}`, {
                    method: "GET",
                    headers: { "Content-Type": "application/json" },
                    credentials: "include",
                });

                if (!res.ok) throw new Error("Failed to fetch permissions");

                const result = await res.json();
                renderItems(result.data);
                renderPagination(result.count, page);
                currentPage = page; // Update current page
            } catch (error) {
                console.error("Error fetching items:", error);
            }
        }

        function renderItems(items) {
            const tableBody = document.querySelector("#permission-table tbody");
            tableBody.innerHTML = "";
            items.forEach(item => {
                tableBody.innerHTML += `
                    <tr>
                        <td>${item.id}</td>
                        <td>${item.name}</td>
                        <td>${item.description}</td>
                        <td>
                            <button onclick="editItem(${item.id}, '${item.name}', '${item.description}')">Edit</button>
                            <button onclick="deleteItem(${item.id})">Delete</button>
                        </td>
                    </tr>`;
            });
        }

        function renderPagination(total, page) {
            const pagination = document.querySelector("#pagination");
            const pages = Math.ceil(total / pageSize);
            pagination.innerHTML = "";
            for (let i = 1; i <= pages; i++) {
                pagination.innerHTML += `<button onclick="fetchItems(${i})" ${i === page ? "disabled" : ""}>${i}</button>`;
            }
        }

        document.querySelector("#itemForm").addEventListener("submit", async function(event) {
            event.preventDefault();

            const id = document.querySelector("#itemId").value;
            const name = document.querySelector("#itemName").value;
            const description = document.querySelector("#itemDescription").value;
            const method = id ? "PUT" : "POST";
            const url = id ? `${apiUrl}/${id}` : apiUrl;

            try {
                const res = await fetch(url, {
                    method,
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ name, description }),
                    credentials: "include",
                });

                if (!res.ok) throw new Error("Failed to save permission");

                this.reset();
                fetchItems(currentPage);
            } catch (error) {
                console.error("Error saving item:", error);
            }
        });


        window.editItem = (id, name, description) => {
            document.querySelector("#itemId").value = id;
            document.querySelector("#itemName").value = name;
            document.querySelector("#itemDescription").value = description;
        };

        window.deleteItem = async (id) => {
            if (confirm("Are you sure?")) {
                try {
                    const res = await fetch(`${apiUrl}/${id}`, {
                        method: "DELETE",
                        credentials: "include",
                    });

                    if (!res.ok) throw new Error("Failed to delete permission");

                    fetchItems(currentPage);
                } catch (error) {
                    console.error("Error deleting item:", error);
                }
            }
        };

        fetchItems();
    });
</script>
